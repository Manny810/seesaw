var F=Object.defineProperty,V=Object.defineProperties;var J=Object.getOwnPropertyDescriptors;var j=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable;var I=(t,e,o)=>e in t?F(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o,T=(t,e)=>{for(var o in e||(e={}))K.call(e,o)&&I(t,o,e[o]);if(j)for(var o of j(e))O.call(e,o)&&I(t,o,e[o]);return t},R=(t,e)=>V(t,J(e));var N=(t,e)=>{var o={};for(var n in t)K.call(t,n)&&e.indexOf(n)<0&&(o[n]=t[n]);if(t!=null&&j)for(var n of j(t))e.indexOf(n)<0&&O.call(t,n)&&(o[n]=t[n]);return o};import{d as w,p as L,c,a as l,n as q,b as _,F as S,o as d,r as x,e as E,f as M,g as G,V as W,h as z,t as H,A as Q,w as X,v as Y,i as Z,j as g,k as b,l as A,m as tt,q as et,s as $,u as ot}from"./vendor.7f4b177a.js";const nt=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function o(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerpolicy&&(i.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?i.credentials="include":s.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=o(s);fetch(s.href,i)}};nt();function P(t){return t.boxes?t.boxes.filter(e=>e.marked_accepted).length>0:!1}function D(t,e,o){const n=new Date;n.setTime(n.getTime()+o*24*60*60*1e3);let s="expires="+n.toUTCString();document.cookie=t+"="+e+";"+s+";path=/"}function st(t){let e=t+"=",n=decodeURIComponent(document.cookie).split(";");for(let s=0;s<n.length;s++){let i=n[s];for(;i.charAt(0)==" ";)i=i.substring(1);if(i.indexOf(e)==0)return i.substring(e.length,i.length)}return null}var C=(t,e)=>{const o=t.__vccOpts||t;for(const[n,s]of e)o[n]=s;return o};const it=w({name:"MAnnotator",props:["initial_imdata","read_only","front_end_type","app_handle"],emits:["cclick","selection"],data:function(){return{height_ratio:null,width_ratio:null,paper:new L.PaperScope,imdata:this.initial_imdata,show_activation:!1,annotation_paper_objs:[],activation_paths:[],activation_layer:null,text_offset:null,text_dict:{},show_float:!1,start_time:Date.now(),drawing_rect:!1}},created:function(){console.log("created annotator")},mounted:function(){new L.Tool,this.text_offset=new this.paper.Point(5,20),console.log("mounted annotator"),this.start_time=Date.now()},methods:{handle_error(t){console.log("error loading image",t),this.$refs.image.src="/home/gridsan/groups/fastai/seesaw/data/error.jpg"},annotator_end:function(){console.log("Annotator End called");var t=Date.now(),e={start_ms:this.start_time,end_ms:t};console.log("Interval:",e),this.imdata.timing==null&&(this.imdata.timing=[]),this.imdata.timing.push(e)},image_accepted(t){return P(t)},activation_press:function(){console.log("checks"),this.show_activation=!this.show_activation,this.show_activation?this.draw_activation():this.clear_activation()},toggle_activation(){this.show_activation=!this.show_activation,this.activation_press()},delete_paper_obj(t){this.annotation_paper_objs=this.annotation_paper_objs.filter(e=>e!=t),t.box.remove(),t.description.remove(),this.save()},draw_activation:function(){console.log("Beginning");let t=this.$refs.image,e=this.$refs.container,o=t.height,n=t.width;e.style.setProperty("width",n+"px"),e.style.setProperty("height",o+"px"),t.style.setProperty("display","block");let s=this.paper;s.activate();let i=null;console.log("before if"),s.project!==null&&(console.log("not null"),i=s.project.activeLayer),console.log("after if"),this.activation_layer=new s.Layer({locked:!0}),s.project.insertLayer(0,this.activation_layer),this.activation_layer.activate(),s.view.draw(),console.log("activations"),console.log(this.initial_imdata.activations);for(let a of this.initial_imdata.activations){let h=a.box,p=this.rescale_box(h,this.height_ratio,this.width_ratio),f=["Rectangle",p.x1,p.y1,p.x2-p.x1,p.y2-p.y1],u=s.Rectangle.deserialize(f),r=new s.Path.Rectangle(u);if(a.score>=0?(r.fillColor="yellow",r.strokeWidth=0,r.opacity=a.score):(r.fillColor="blue",r.strokeWidth=0,r.opacity=-a.score),this.activation_paths.push(r),this.show_float){let m="black",y=new s.Point(p.x1+this.text_offset.x,p.y2-this.text_offset.y),k=new s.PointText(y);k.justification="left",k.fillColor=m,k.fontSize=12,k.content=a.score.toFixed(2),this.activation_paths.push(k)}}i!==null&&i.activate(),s.view.draw(),s.view.update()},clear_activation:function(){for(this.activation_layer.remove(),this.activation_layer=null;this.activation_paths.length!==0;){var t=this.activation_paths.pop();t.remove()}},rescale_box:function(t,e,o){let p=t,{x1:n,x2:s,y1:i,y2:a}=p,h=N(p,["x1","x2","y1","y2"]);return T({x1:n*o,x2:s*o,y1:i*e,y2:a*e},h)},paper2imdata(t){let e=t.box.bounds,o={x1:e.left,x2:e.right,y1:e.top,y2:e.bottom},n=this.rescale_box(o,this.height_ratio,this.width_ratio);return n.description=t.description.content,n.marked_accepted="marked_accepted"in t.box.data?t.box.data.marked_accepted:!1,n},save:function(){this.paper.activate();let e=this.annotation_paper_objs.map(this.paper2imdata);console.assert(e!=null),console.log("saving state from paper to local imdata "),e.length==0?(this.imdata.boxes=null,console.log("length 0 reverts to null right now")):this.imdata.boxes=e},get_latest_imdata(){return this.save(),this.imdata},load_current_box_data:function(){let t=this.paper;if(t.activate(),this.initial_imdata.boxes!=null){console.log("drawing boxes",this.initial_imdata.boxes);for(const e of this.initial_imdata.boxes)this.draw_box(e,t)}},draw_box:function(t,e){let o=t.marked_accepted?"green":"red",n=this.rescale_box(t,this.height_ratio,this.width_ratio),s=["Rectangle",n.x1,n.y1,n.x2-n.x1,n.y2-n.y1],i=e.Rectangle.deserialize(s),a=new e.Path.Rectangle(i);a.data.marked_accepted=t.marked_accepted,a.strokeColor=o,a.strokeWidth=6,a.data.state=null,a.selected=!1;let h=new e.Point(n.x1+this.text_offset.x,n.y1+this.text_offset.y),p=new e.PointText(h);p.justification="left",p.fillColor=o,p.fontSize=12,p.content=t.description,this.text_dict[a]=p;let f={box:a,description:p};return this.annotation_paper_objs.push(f),f},hover:function(t){this.read_only&&(t?this.$refs.image.style.opacity=.5:this.$refs.image.style.opacity=1)},canvas_click:function(t){console.log("canvas click!",t),this.$emit("cclick",t)},load_handler(){console.log("image loaded"),this.app_handle&&~this.read_only&&this.app_handle.log("image_loaded"),this.draw_initial_contents()},draw_initial_contents:function(){console.log("(draw)setting up",this);let t=this.$refs.image,e=this.$refs.container,o=t.height,n=t.width;e.style.setProperty("width",n+"px"),e.style.setProperty("height",o+"px"),t.style.setProperty("display","block");let s=this.paper;s.activate();let i=this.$refs.canvas;console.log("drawing canvas",t.height,t.width,t),i.height=o,i.width=n,this.paper.setup(i),this.height_ratio=o/t.naturalHeight,this.width_ratio=n/t.naturalWidth,this.paper.view.draw(),!(this.read_only&&(this.initial_imdata.boxes===null||this.initial_imdata.boxes.length===0))&&(this.load_current_box_data(),!this.read_only&&this.front_end_type!=="plain"&&this.setup_box_drawing_tool(s),s.view.draw(),s.view.update(),this.front_end_type==="pytorch"&&!this.read_only&&this.activation_press())},full_box_present(){this.paper.activate();let e=this.annotation_paper_objs.map(this.paper2imdata),o=this.$refs.image,n=o.height,s=o.width;for(var i in e){let a=e.at(i);if(console.log(a),a.x1==0&&a.x2==s&&a.y1==0&&a.y2==n)return!0}return!1},draw_full_frame_box(t){let e=this.paper;e.activate(),e.project.getSelectedItems().map(u=>u.selected=!1);let n=!0,s=this.annotation_paper_objs.map(this.paper2imdata),i=this.$refs.image,a=i.height,h=i.width;for(var p in s){let u=s.at(p);if(console.log(u),u.x1==0&&u.x2==h&&u.y1==0&&u.y2==a){n=!1,console.log("Box not drawn, box returned"),console.log(u);let r=this.annotation_paper_objs.at(p);console.log(r),r.box.selected=!0}}if(n){let u={x1:0,x2:h,y1:0,y2:a,description:"",marked_accepted:t},r=this.draw_box(u,e);console.log(r),r.box.selected=!0}this.save();let f=this.annotation_paper_objs.filter(u=>u.box.selected);this.full_box=f[0],f.length===1&&this.$emit("selection",f[0])},makeRect(t,e){this.paper.activate();let o=new this.paper.Path.Rectangle(t,e);return o.strokeWidth=4,o.data.state=null,this.front_end_type==="plain"||this.front_end_type==="pytorch"?o.data.marked_accepted=!0:o.data.marked_accepted=!1,o.strokeColor=o.data.marked_accepted?"green":"red",o.selected=!1,o},redraw_text:function(t){let e=this.text_dict[t],o=this.paper;this.paper.activate();let n=new o.Point(t.bounds.x+this.text_offset.x,t.bounds.y+this.text_offset.y);e.point=n},setup_box_drawing_tool:function(t){let e=t.tool,o=this.makeRect;e.onMouseDown=n=>{let s={segments:!0,stroke:!0,fill:!0,class:t.Path,tolerance:10};console.log("mouse down");let i=t.project.hitTest(n.point,s),a=t.project.getSelectedItems();a.map(f=>f.selected=!1);let h=null;if(i==null&&a.length>0)return;if(i==null){h=o(n.point.subtract(new t.Size(1,1)),n.point),console.log("Point: ",n.point);let f=new t.Point(n.point.x+this.text_offset.x,n.point.y+this.text_offset.y);console.log("New Points:",f);let u=new t.PointText(f);u.justification="left",u.fillColor=h.data.marked_accepted?"green":"red",u.content="",this.text_dict[h]=u;let r={box:h,description:u};this.annotation_paper_objs.push(r),this.drawing_rect=!0}else h=i.item;if(h.selected=!0,this.annotation_paper_objs.filter(f=>f.box.selected).length==1||console.log("multiple/zero selected items"),i!=null&&i.type==="stroke"){h.data.state="moving";return}if(i==null||i.type==="segment"){h.data.state="resizing";let f=h.bounds;const u=[["getTopLeft","getTopRight"],["getBottomLeft","getBottomRight"]];for(let r=0;r<2;r++)for(let m=0;m<2;m++){let y=u[r][m];if(f[y]().isClose(n.point,s.tolerance)){let U=u[(r+1)%2][(m+1)%2];h.data.from=f[U](),h.data.to=f[y]()}}}},e.onMouseUp=()=>{console.log("Mouse up"),this.save();let n=this.annotation_paper_objs.filter(a=>a.box.selected);if(n.length===1){var s=n.map(this.paper2imdata),i=s[0];this.drawing_rect&&(i.x2-i.x1<10||i.y2-i.y1<10)?this.delete_paper_obj(n[0]):this.$emit("selection",n[0])}else this.$emit("selection",null);this.drawing_rect=!1},e.onKeyUp=n=>{},e.onMouseDrag=n=>{let s=t.project.getSelectedItems(),i=null;if(s.length===1){if(i=s[0],i.data.state==="moving")i.position=i.position.add(n.point).subtract(n.lastPoint);else if(i.data.state==="resizing"){let a=new t.Rectangle(i.data.from,n.point);a.width!==0&&a.height!==0&&(i.bounds=a)}this.redraw_text(i)}},console.log("finished setting up box annotation tool ")}}}),at={class:"annotator_div row",ref:"container"},lt=["src"];function rt(t,e,o,n,s,i){return d(),c(S,null,[l("div",at,[l("img",{class:q(t.read_only?"annotator_image_small":"annotator_image"),src:t.imdata.url,ref:"image",onError:e[0]||(e[0]=(...a)=>t.handle_error&&t.handle_error(...a)),onLoad:e[1]||(e[1]=(...a)=>t.load_handler&&t.load_handler(...a))},null,42,lt),l("canvas",{class:"annotator_canvas",ref:"canvas",onClick:e[2]||(e[2]=(...a)=>t.canvas_click&&t.canvas_click(...a)),onMouseover:e[3]||(e[3]=a=>t.hover(!0)),onMouseleave:e[4]||(e[4]=a=>t.hover(!1))},null,544),_(` <div
        class="form-check activation-check">
        <input
            class="form-check-input"
            type="checkbox"
            id="activation-checkbox"
            v-model="this.show_activation"
            @change="this.activation_press()"
        >
    </div> `)],512),_(` question: could the @load callback for img fire before created() or mounted()? (
    eg, the $refs and other vue component object attributes) `)],2112)}var B=C(it,[["render",rt],["__scopeId","data-v-00a7bec8"]]);const dt=w({name:"MImageGallery",components:{"m-annotator":B},props:{initial_imdata:{type:Array,default:()=>[]},imdata_keys:{type:Array}},emits:["selection"],data:function(){return{selection:null}},created:function(){},mounted:function(){},methods:{get_class(t){let e=this.initial_imdata[t];if(e.boxes==null)return"unknown";if(e.boxes.length>0)return"accepted";if(e.boxes.length===0)return"rejected"},image_accepted(t){return P(t)}}}),ct={class:"row"},_t={class:"image-gallery"};function ht(t,e,o,n,s,i){const a=x("m-annotator");return d(),c("div",null,[l("div",ct,[l("div",_t,[(d(!0),c(S,null,E(t.initial_imdata,(h,p)=>(d(),c("div",{key:t.imdata_keys[p]},[M(a,{class:q(t.image_accepted(h)?"gallery-accepted":""),ref_for:!0,ref:"annotators",initial_imdata:h,read_only:!0,onCclick:f=>{t.$emit("selection",p)}},null,8,["class","initial_imdata","onCclick"])]))),128))])])])}var pt=C(dt,[["render",ht],["__scopeId","data-v-67a22cc0"]]);const ut=w({name:"MModal",data:function(){return{active:!0,handler:null}},emits:["modalKeyUp"],mounted:function(){this.$data.handler=this.handle_keyup,window.addEventListener("keydown",this.handle_keydown),window.addEventListener("keyup",this.handle_keyup),document.getElementsByTagName("body")[0].classList.add("modal-is-active")},unmounted:function(){window.removeEventListener("keydown",this.handle_keyup),window.removeEventListener("keyup",this.handle_keyup),document.getElementsByTagName("body")[0].classList.remove("modal-is-active")},methods:{handle_keyup(t){this.$emit("modalKeyUp",t)},handle_keydown(t){this.$emit("modalKeyDown",t)}}}),ft={class:"my-modal-content"};function gt(t,e,o,n,s,i){return d(),c(S,null,[_(" mostly based on https://www.w3schools.com/howto/howto_css_modal_images.asp "),l("div",{class:q(`my-modal ${t.active?"my-modal-active":""}`)},[_(` <span
      class="close"
      @click="close"
    >&times;</span> `),l("div",ft,[G(t.$slots,"default")])],2)],2112)}var mt=C(ut,[["render",gt]]);const yt=w({components:{Vue3JsonEditor:W},props:["default_params"],setup(t){function e(i){console.log("value:",i),s.json=i}function o(){return s.json}function n(i){console.log("Update called in config"),s.json=i}const s=z({json:t.default_params});return R(T({},H(s)),{onJsonChange:e,currentConfig:o,updateClientData:n})}});function vt(t,e,o,n,s,i){const a=x("Vue3JsonEditor");return d(),c("div",null,[M(a,{modelValue:t.json,"onUpdate:modelValue":e[0]||(e[0]=h=>t.json=h),"show-btns":!0,expandedOnStart:!0,onJsonChange:t.onJsonChange},null,8,["modelValue","onJsonChange"])])}var bt=C(yt,[["render",vt]]);const xt=w({name:"MExampleImageGallery",props:{urls:{type:Array,default:()=>[]}},data:function(){return{}},created:function(){},mounted:function(){},methods:{}}),kt={class:"row"},wt={class:"image-gallery"},$t=["src"];function Ct(t,e,o,n,s,i){return d(),c("div",null,[l("div",kt,[l("div",wt,[(d(!0),c(S,null,E(t.urls,a=>(d(),c("div",null,[l("img",{class:q("annotator_image_small"),src:a},null,8,$t)]))),256))])])])}var St=C(xt,[["render",Ct],["__scopeId","data-v-fb336806"]]);const jt=w({components:{"m-image-gallery":pt,"m-modal":mt,"m-annotator":B,MConfigVue3:bt,Autocomplete:Q,MExampleImageGallery:St},props:{},data(){return{client_data:{session:null,indices:[],default_params:{}},path_error:!1,selected_index:null,session_path:null,selection:null,text_query:null,imdata_knum:{},keys:{},new_session_params:null,annotator_text:"",annotator_text_pointer:null,show_config:!1,other_url:null,autocomplete_items:[],task_info:null,front_end_type:"textual",button_labels:{test:{add:"Add Button"}},image_index:null,loading_next:!1,allow_full_box:!1,end_query:!1,example_urls:null,example_neg_urls:null,notif_description:null,next_task_ready:!1,task_started:!1,task_start_time:Date.now(),path_mode:!1,user_test_mode:!1}},mounted(){window.VueApp=this;let t=new URLSearchParams(window.location.search);if(window.location.pathname==="/session_info"){let e=t.get("path");this.load_session(e),this.path_mode=!0}else if(window.location.pathname==="/compare"){let e=t.get("path");this.other_url=`${window.location.origin}/session_info?path=${t.get("other")}`,this.load_session(e)}else window.location.pathname==="/user_session"?fetch("/api/user_session?"+t,{method:"POST"}).then(e=>e.json()).then(this._update_client_data):window.location.pathname==="/session"?fetch("/api/session?"+t,{method:"POST"}).then(e=>e.json()).then(this._update_client_data):window.location.pathname==="/session_end"?fetch("/api/session_end",{method:"POST"}).then(e=>e.json()).then(e=>console.log("session ended",e)):(this.path_error=!0,console.log("unknown path",window.location.pathname));this.checkContainer()},methods:{is_task_finished(){let t=this.total_accepted(),e=Math.floor((Date.now()-this.task_start_time)/1e3);var o=t>=10||e>=60*6;return console.log("Accepted Images: ",t),console.log("Change time: ",Math.floor((Date.now()-this.task_start_time)/1e3)),{value:o,accepted:t,seconds_lasted:e}},nextButtonClick(){let t=this.is_task_finished();t.value&&this.user_test_mode&&(this.close_modal(),this.get_end_description(t)),this.image_index<this.total_images()?this.moveRight():this.loading_next||this.next(!0)},log(t,e){this.path_mode||this.client_data.session.action_log.push({logger:"client",time:Date.now()/1e3,seen:this.total_images(),accepted:this.total_accepted(),message:t,other_fields:e})},checkContainer(){let t=document.querySelector(".vue3-input");t!==null&&t.focus(),setTimeout(this.checkContainer,1e3)},mark_image_accepted(){this.$refs.annotator.draw_full_frame_box(!0)},toggle_box_accepted(){this.annotator_text_pointer.box.data.marked_accepted?(this.annotator_text_pointer.box.data.marked_accepted=!1,this.annotator_text_pointer.box.strokeColor="red",this.annotator_text_pointer.description.fillColor="red"):(this.annotator_text_pointer.box.data.marked_accepted=!0,this.annotator_text_pointer.box.strokeColor="green",this.annotator_text_pointer.description.fillColor="green")},image_accepted(t){return P(t)},updateRecommendations(){if(this.autocomplete_items=[],this.client_data.session){for(var t of this.client_data.session.gdata)for(var e of t)if(e.boxes!==null)for(var o of e.boxes)!this.autocomplete_items.includes(o.description)&&o.description!==""&&o.description!==null&&this.autocomplete_items.push(o.description)}},set_frontend_type(t){switch(t){case"default":this.front_end_type="plain";break;case"pytorch":case"fine":this.front_end_type="pytorch";break;default:console.log(`unknown mode ${params.get("mode")}.`)}},changeInput(t){console.log("change Input"+t),this.annotator_text=t,this.autocomplete_items=this.autocomplete_items.filter(e=>{if(e.includes(t))return e})},get_session_id(){return st("session_id")},set_session_id(t){t&&(console.log("setting session id",t),D("session_id",t,1))},delete_session_id(){D("session_id","",0)},inputSelect(t){console.log("input Select: "+t),this.annotator_text=t,this.annotator_text_pointer.description.content=this.annotator_text,this.annotator_text_pointer=null},total_images(){return this.client_data.session.gdata.map(t=>t.length).reduce((t,e)=>t+e,0)},toggle_config(){this.show_config=!this.show_config},load_session(t){this.session_path=t,fetch("/api/session_info",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:t})}).then(e=>e.json()).then(this._update_client_data)},get_end_description(t){let e=this.client_data.worker_state.current_task_index;this.task_started=!1,e!=-1&&this.log("task.end",t),e==this.client_data.worker_state.task_list.length-1?this.finish_session():fetch("/api/task_description?code="+this.client_data.worker_state.task_list[e+1].qkey,{method:"GET"}).then(o=>o.json()).then(this._update_notify_module)},finish_session(){let t={client_data:this.$data.client_data};this.path_mode||fetch("/api/session_end",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>e.json()).then(this._finish_session_data)},next_task(){let t=this.client_data.worker_state.current_task_index;if(this.next_task_ready=!1,t==this.client_data.worker_state.task_list.length-1)console.log("last session");else{let e={client_data:this.$data.client_data};this.path_mode||fetch("/api/next_task",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(o=>o.json()).then(this._update_client_data)}},load_next_task(){this.end_query=!1,this.task_started==!1&&this.text(this.text_query),this.task_started=!0},total_accepted(){let t=e=>e.map(o=>P(o)?1:0).reduce((o,n)=>o+n,0);return this.client_data.session.gdata.map(t).reduce((e,o)=>e+o,0)},total_annotations(){let t=function(e){let o=0;for(const n of e)n.boxes!=null&&(o+=n.boxes.length);return o};return this.client_data.session.gdata.map(t).reduce((e,o)=>e+o,0)},get_nth_idcs(t){var e=t;for(const[o,n]of this.client_data.session.gdata.entries()){if(console.assert(e>=0),e<n.length)return{gdata_idx:o,local_idx:e};e-=n.length}console.assert(!1,t)},get_global_idx(t,e){var o=0;console.assert(t>=0);for(const[n,s]of this.client_data.session.gdata.entries()){if(n===t)return console.assert(e<s.length),o+e;o+=s.length}console.assert(!1,"should not reach this",t,e)},handle_selection_change(t){if(this.$refs.annotator!=null){let e=this.$refs.annotator.get_latest_imdata();this.data_update(e)}this.selection!=t&&this.$refs.annotator!=null&&this.$refs.annotator.annotator_end(),this.log("selection.end",this.selection),this.selection=t,this.log("selection.start",t),this.selection!==null?this.image_index=this.get_global_idx(this.selection.gdata_idx,this.selection.local_idx)+1:this.image_index=null},toggle_plain_accepted(){this.checkForFullBox()?this.delete_full_box():this.mark_image_accepted()},toggle_mark_accepted(){this.annotator_text_pointer.box.data.marked_accepted?this.annotator_text_pointer.box.strokeColor="green":this.annotator_text_pointer.box.strokeColor="yellow"},handleAnnotatorSelectionChange(t){console.log("annotator sel change",t),this.annotator_text_pointer!=null&&(this.annotator_text_pointer.description.content=this.annotator_text),t!=null?(console.log("predicted path"),this.annotator_text_pointer=t,this.annotator_text=this.annotator_text_pointer.description.content,console.log(this.annotator_text_pointer)):this.annotator_text_pointer=null,this.updateRecommendations()},checkForFullBox(){if(this.$refs.annotator===null||this.$refs.annotator===void 0)return!1;let t=this.$refs.annotator.full_box_present();return console.log("check for full box returning",t,this.$refs.annotator),t},moveLeft(){if(!(this.image_index===1||this.image_index===null)){let t=-1;this.handle_arrow(t)}},moveRight(){let t=1;this.handle_arrow(t)},sButtonClick(){this.front_end_type!=="plain"&&this.annotator_text_pointer!==null?this.delete_annotation():this.front_end_type==="plain"&&this.toggle_plain_accepted()},toggleActivation(){this.front_end_type==="pytorch"&&(this.$refs.highlight_btn.blur(),this.$refs.annotator.activation_press())},handleModalKeyUp(t,e){if(console.log("AM I HEARING?"),t==="up"){if(this.end_query){this.user_test_mode&&this.selection&&e.code=="KeyQ"&&(this.log("query_info.end"),this.end_query=!1);return}if(console.log("within modalKeyUp handler",e),this.annotator_text_pointer==null||this.front_end_type!=="textual")console.log("EV CODE"),console.log(e.code),e.code==="KeyD"?this.nextButtonClick():e.code==="Escape"?(this.path_mode||!this.user_test_mode)&&this.close_modal():e.code==="KeyA"?this.moveLeft():e.code=="KeyW"?this.front_end_type==="pytorch"&&this.allow_full_box&&this.mark_image_accepted():e.code=="KeyE"?this.toggleActivation():e.code=="KeyS"?this.sButtonClick():e.code=="KeyQ"?(this.log("query_info.start"),this.end_query=!0):e.code=="Space"||e.code=="Enter"&&!this.user_test_mode&&this.text(this.text_query);else if(e.code=="Escape")this.handleAnnotatorSelectionChange(null),this.close_modal();else if(e.code==="ArrowLeft"||e.code==="ArrowRight"){this.handleAnnotatorSelectionChange(null);let o=e.code==="ArrowLeft"?-1:1;this.handle_arrow(o)}else e.code=="Enter"&&this.handleAnnotatorSelectionChange(this.annotator_text_pointer)}},delete_annotation(){this.$refs.annotator.delete_paper_obj(this.annotator_text_pointer),this.handleAnnotatorSelectionChange(null)},delete_full_box(){this.checkForFullBox()&&(this.$refs.annotator.draw_full_frame_box(!0),this.delete_annotation())},create_full_box(){console.log("create full box ran"),this.$refs.annotator.draw_full_frame_box(!1)},handle_arrow(t){if(this.selection!=null){let{gdata_idx:e,local_idx:o}=this.selection,n=this.total_images(),i=this.get_global_idx(e,o)+t;if(i>=0&&i<n){console.log("about to switch"),this.annotator_text_pointer=null;let a=this.get_nth_idcs(i);this.handle_selection_change(a)}else console.log("not legal to switch",e,o,i)}},get_vue_key(t){let e=0;return t in this.imdata_knum&&(e=this.imdata_knum[t]),t*1e4+e},incr_vue_key(t){t in this.imdata_knum?this.imdata_knum[t]+=1:this.imdata_knum[t]=1},data_update(t){console.log("data_update",t),this.client_data.session.gdata[this.selection.gdata_idx][this.selection.local_idx]=t,this.incr_vue_key(t.dbidx),this.updateRecommendations()},_update_next_task(t){console.log("Update Next Task Data: ",t)},_update_notify_module(t){console.log("Notify Module Data: ",t),this.notif_description=t.description,this.example_urls=t.urls,this.example_neg_urls=t.neg_urls,this.end_query=!0,this.next_task()},_finish_session_data(t){this.notif_description.description="Completed Survey. Survey Code: "+t.token,this.notif_description.negative_description="",this.notif_description.qstr=null,this.notif_description.dataset=null,this.end_query=!0,this.example_urls=null,this.example_neg_urls=[],this.next_task_ready=!1},_update_client_data(t,e=!1){console.log("current data",this.$data),console.log("update client data",t,e),this.client_data=t,this.updateRecommendations(),this.client_data.session!=null?(this.selected_index=this.client_data.session.params.index_spec,this.text_query=this.client_data.session.query_string,this.set_frontend_type(this.client_data.session.params.other_params.mode),"qstr"in this.client_data.session.params.other_params&&this.client_data.session.gdata.length==0&&(this.text_query=this.client_data.session.params.other_params.qstr)):this.selected_index=null,this.client_data.worker_state.current_task_index==-1&&this.user_test_mode&&this.get_end_description({}),this.next_task_ready=!0},reset(t){let e=this.$refs.config.currentConfig(),o={config:null};t!=null&&(o.config=T({},e)),this.client_data.session=null,console.log("reset request",o),this.path_mode||fetch("/api/reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then(n=>n.json()).then(n=>this._update_client_data(n,!0))},text(t){let e=new URLSearchParams({key:t});console.log("RUNNING TEXT"),console.log(t),this.path_mode||fetch("/api/text?"+e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})}).then(o=>o.json()).then(o=>{console.log("text cb"),this._update_client_data(o),this.user_test_mode&&(this.selection===void 0||this.selection===null)&&(this.$refs.text_input.blur(),this.log("task.started"),this.task_start_time=Date.now(),this.handle_selection_change({gdata_idx:0,local_idx:0}))}).catch(o=>console.log(o))},next(t=!1){if(this.loading_next)console.log("PREVENTED NEXT DUE TO WAITING");else{this.log("next_req.start"),this.loading_next=!0;let e={client_data:this.$data.client_data};this.path_mode||fetch("/api/next",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(o=>o.json()).then(o=>{let n=o;this.log("next_req.end"),this._update_client_data(n),this.loading_next=!1,t?(console.log("hanlding ret",t,"this",this),this.moveRight()):console.log("no move right")}).catch(o=>{console.log("Error in next: ",o),this.loading_next=!1})}},close_modal(){this.handle_selection_change(null)}}}),v=t=>(tt("data-v-6bc3ab3c"),t=t(),et(),t),Tt={class:"navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow"},At=v(()=>l("a",{class:"navbar-brand col-md-3 col-lg-2 me-0 px-3",href:"#"},"SeeSaw",-1)),Mt=v(()=>l("button",{class:"navbar-toggler position-absolute d-md-none collapsed",type:"button","data-bs-toggle":"collapse","data-bs-target":"#sidebarMenu","aria-controls":"sidebarMenu","aria-expanded":"false","aria-label":"Toggle navigation"},[l("span",{class:"navbar-toggler-icon"})],-1)),Pt=v(()=>l("div",{class:"navbar-nav col-lg-1 px-3"},null,-1)),qt={class:"container-fluid"},Et={id:"sidebarMenu",class:"col-md-3 col-lg-2 d-md-block bg-light sidebar collapse"},It={class:"position-sticky pt-3"},Kt=v(()=>l("div",{class:"row"},[l("div",{class:"col"},[_(` <div class="row">
                <label>Current Database:</label>
              </div> `),_(` <div class="row">
                <select
                  v-model="selected_index"
                  @change="reset(selected_index)"
                >
                  <option
                    v-for="(idxspec,idx) in [null, ...client_data.indices]"
                    :key="idx"
                    :value="idxspec"
                  >
                    {{ idxspec != null ? \`\${idxspec.d_name}:\${idxspec.i_name}\` : '' }}
                  </option>
                </select> 
              </div> 
            `)])],-1)),Ot={key:0,class:"row"},Rt={key:1,class:"row"},Nt={key:2,class:"row"},Lt={class:"row"},Dt={key:0,class:"col-md-9 ms-sm-auto col-lg-10 px-md-4"},Bt={key:0,class:"row"},Ut=["href"],Ft=["href"],Vt={key:1,class:"row"},Jt=["href"],Gt={class:"row"},Wt={key:0},zt=v(()=>l("span",{class:"background-span"}," Error: Unknown application path ",-1)),Ht=v(()=>l("span",{class:"background-span"}," Loading... ",-1)),Qt={class:"keyword-text"},Xt=$(" Looking for "),Yt={key:0},Zt={key:0},te={key:0},ee={key:0,class:"btn btn-danger",onfocus:"blur()"},oe={key:1,class:"button-row"},ne=["disabled"],se={key:0,class:"button-row"},ie={class:"btn btn-danger",ref:"accept_button",onfocus:"blur()"},ae={key:1,class:"button-row"},le=["disabled"],re=["disabled"],de={class:"keyword-text"},ce={class:"row"},_e={class:"keyword-text"},he={key:0},pe=$(" In the following task, you'll be looking for "),ue={key:1},fe=$(" Below are some examples of "),ge=$(". "),me={class:"keyword-text"},ye={key:0},ve=$(" Below are some examples of what "),be=v(()=>l("b",null," NOT ",-1)),xe=$(" to select. "),ke=[ve,be,xe],we=v(()=>l("span",null," When you are ready and the OK button is enabled, press it to proceed.",-1)),$e=["disabled"];function Ce(t,e,o,n,s,i){const a=x("m-image-gallery"),h=x("m-modal"),p=x("Autocomplete"),f=x("m-annotator"),u=x("m-example-image-gallery");return d(),c("div",null,[_(" adapted from https://github.com/twbs/bootstrap/blob/main/site/content/docs/5.0/examples/dashboard/index.html  "),l("header",Tt,[At,X(l("input",{class:"form-control form-control-dark w-auto",type:"text",placeholder:"Search","aria-label":"Search","onUpdate:modelValue":e[0]||(e[0]=r=>t.text_query=r),ref:"text_input",onKeyup:e[1]||(e[1]=Z(r=>t.text(t.text_query),["enter"]))},null,544),[[Y,t.text_query]]),Mt,Pt]),_(` <div v-show="show_config" 
      class="container"> 
      <m-config-vue-3
        ref="config"
        v-bind:client_data="client_data.default_params"
      />
    </div> `),l("div",qt,[l("nav",Et,[l("div",It,[Kt,t.client_data.session!=null?(d(),c("div",Ot,[l("span",null,"Current database: "+g(t.selected_index.d_name),1)])):_("v-if",!0),t.client_data.session!=null?(d(),c("div",Rt,[l("span",null,"Total images: "+g(t.total_images()),1)])):_("v-if",!0),t.client_data.session!=null?(d(),c("div",Nt,[l("span",null,"Total accepted: "+g(t.total_accepted()),1)])):_("v-if",!0),_(` <div class="row" v-if="client_data.session != null">
            <button 
              class="btn btn-dark btn-block" 
              @click="save()"
            > 
              Save 
            </button>
          </div> `),_(` <div class="row" v-if="client_data.session != null">
            <button
              class="btn btn-dark btn-block"
              @click="reset(client_data.session.params.index_spec)"
            >
              Reset
            </button>
          </div> `),l("div",Lt,[t.show_config?(d(),c("button",{key:0,class:"btn btn-dark btn-block",onClick:e[2]||(e[2]=r=>t.toggle_config())}," Hide Config ")):(d(),c("button",{key:1,class:"btn btn-dark btn-block",onClick:e[3]||(e[3]=r=>t.toggle_config())}," Show Config "))])])]),t.client_data.session!=null?(d(),c("main",Dt,[t.session_path!==null?(d(),c("div",Bt,[l("a",{href:`${t.session_path}/stdout`},"stdout",8,Ut),l("a",{href:`${t.session_path}/stderr`},"stderr",8,Ft)])):_("v-if",!0),t.other_url!==null?(d(),c("div",Vt,[l("a",{href:t.other_url},g(t.other_url),9,Jt)])):_("v-if",!0),(d(!0),c(S,null,E(t.client_data.session.gdata,(r,m)=>(d(),c("div",{class:"row",key:m},[_(` <div
            v-if="client_data.session.timing.length > 0"
            class="row"
          >
            <span>Search refinement took {{ client_data.session.timing[idx].toFixed(2) }} seconds</span>
          </div> `),l("div",Gt,[r.length>0?(d(),b(a,{key:0,ref_for:!0,ref:"galleries",initial_imdata:r,imdata_keys:r.map(y=>t.get_vue_key(y.dbidx)),onSelection:y=>t.handle_selection_change({gdata_idx:m,local_idx:y})},null,8,["initial_imdata","imdata_keys","onSelection"])):_("v-if",!0)]),_(' <div class="row space" /> ')]))),128)),_(` <div
          class="row"
          v-if="client_data.session.gdata.length > 0"
        >
          <button
            @click="next(false)"
            class="btn btn-dark btn-block"
          >
            Load More Images
          </button>
        </div> `)])):_("v-if",!0)]),t.user_test_mode?(d(),c("div",Wt,[t.path_error?(d(),b(h,{key:0,class:"xmodal"},{default:A(()=>[zt]),_:1})):t.path_mode?_("v-if",!0):(d(),b(h,{key:1,class:"xmodal"},{default:A(()=>[Ht]),_:1}))])):_("v-if",!0),t.selection!=null?(d(),b(h,{key:1,ref:"modal",onModalKeyDown:e[11]||(e[11]=r=>t.handleModalKeyUp("down",r)),onModalKeyUp:e[12]||(e[12]=r=>t.handleModalKeyUp("up",r))},{default:A(()=>[l("div",Qt,[l("span",null,[Xt,l("b",null,g(this.client_data.session.query_string),1)])]),t.annotator_text_pointer!=null?(d(),c("div",Yt,[t.front_end_type!=="plain"?(d(),c("div",Zt,[t.front_end_type!=="pytorch"?(d(),c("div",te,[t.annotator_text_pointer.box.data.marked_accepted?(d(),c("button",{key:0,class:"btn btn-danger",onClick:e[4]||(e[4]=r=>t.toggle_box_accepted()),onfocus:"blur()"}," Mark Negative ")):(d(),c("button",{key:1,class:"btn btn-danger",onClick:e[5]||(e[5]=r=>t.toggle_box_accepted()),onfocus:"blur()"}," Mark Accepted "))])):_("v-if",!0),this.front_end_type==="textual"?(d(),b(p,{key:1,onInput:t.changeInput,onOnSelect:t.inputSelect,results:t.autocomplete_items,placeholder:t.annotator_text,"results-container-class":["custom-vue3-results-container"]},null,8,["onInput","onOnSelect","results","placeholder"])):_("v-if",!0)])):_("v-if",!0)])):_("v-if",!0),l("div",null,[t.user_test_mode?(d(),c("button",ee," Key Q: Show Examples ")):_("v-if",!0),t.front_end_type==="pytorch"&&t.allow_full_box?(d(),c("div",oe,[t.checkForFullBox()?(d(),c("button",{key:0,class:"btn btn-danger",onClick:e[6]||(e[6]=r=>t.mark_image_accepted()),onfocus:"blur()"}," Select Full Box (W) ")):(d(),c("button",{key:1,class:"btn btn-danger",onClick:e[7]||(e[7]=r=>t.mark_image_accepted()),onfocus:"blur()"}," Create Full Box (W) "))])):_("v-if",!0),t.front_end_type!=="plain"?(d(),c("button",{key:2,class:"btn btn-warning highlight-button",ref:"highlight_btn",onClick:e[8]||(e[8]=()=>{this.$refs.highlight_btn.blur()})}," Key E : Toggle Highlight ",512)):_("v-if",!0)]),l("div",null,[l("button",{class:"btn btn-danger",ref:"left_button",disabled:this.image_index===1||this.image_index===null,onfocus:"blur()"}," Key A : Previous ",8,ne),t.front_end_type==="plain"?(d(),c("div",se,[l("button",ie," Key S : Toggle Accept ",512)])):t.front_end_type==="textual"?(d(),c("div",ae,[l("button",{class:"btn btn-danger",onClick:e[9]||(e[9]=r=>t.create_full_box()),onfocus:"blur()"}," Full Box ")])):_("v-if",!0),t.front_end_type!=="plain"?(d(),c("button",{key:2,class:"btn btn-danger",disabled:t.annotator_text_pointer==null,onfocus:"blur()"}," Key S : Delete Box ",8,le)):_("v-if",!0),l("button",{class:"btn btn-danger",ref:"right_button",onfocus:"blur()",disabled:t.loading_next}," Key D : Next ",8,re)]),l("div",de,[l("span",null," Image "+g(this.image_index)+" of "+g(this.total_images()),1)]),l("div",ce,[(d(),b(f,{ref:"annotator",initial_imdata:this.client_data.session.gdata[this.selection.gdata_idx][this.selection.local_idx],read_only:!1,front_end_type:this.front_end_type,onSelection:e[10]||(e[10]=r=>t.handleAnnotatorSelectionChange(r)),key:t.get_vue_key(this.client_data.session.gdata[this.selection.gdata_idx][this.selection.local_idx].dbidx),app_handle:this},null,8,["initial_imdata","front_end_type"]))])]),_:1},512)):_("v-if",!0),t.end_query==!0&&t.user_test_mode?(d(),b(h,{key:2,ref:"notif-modal",onModalKeyDown:e[14]||(e[14]=r=>t.handleModalKeyUp("down",r)),onModalKeyUp:e[15]||(e[15]=r=>t.handleModalKeyUp("up",r))},{default:A(()=>[l("div",null,[l("div",_e,[this.notif_description.qstr?(d(),c("span",he,[pe,l("b",null,g(this.notif_description.qstr)+".",1)])):_("v-if",!0),l("span",null,g(this.notif_description.description),1),this.notif_description.qstr?(d(),c("span",ue,[fe,l("b",null,g(this.notif_description.qstr),1),ge])):_("v-if",!0)]),M(u,{urls:t.example_urls},null,8,["urls"]),l("div",me,[l("span",null,g(this.notif_description.negative_description),1),this.notif_description.negative_description?(d(),c("span",ye,ke)):_("v-if",!0),we]),M(u,{urls:t.example_neg_urls},null,8,["urls"]),l("button",{class:"btn btn-danger",onfocus:"blur()",onClick:e[13]||(e[13]=r=>t.load_next_task()),disabled:!t.next_task_ready}," OK ",8,$e)])]),_:1},512)):_("v-if",!0)])}var Se=C(jt,[["render",Ce],["__scopeId","data-v-6bc3ab3c"]]);ot(Se).mount("#app");
